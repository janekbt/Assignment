---
title: "Assignment"
author: "Janek Teders"
date: "December 8, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE, cache = TRUE)
library(knitr)
library(readxl)
library(tidyverse)
set.seed(20190108)
load("0_data/Variables_from_Model_Answers.RData")
```

# 1. Regarding the DBC

## 1.1 Load the DBC codes and its descriptions

```{r}
dat <- read_xlsx("0_data/Tarievenoverzicht_HA1.xlsx", sheet = 1) %>%
  select(Code, "Omschrijving type 1") %>%
  mutate(Code = as.numeric(Code))

all.equal(dat, Dutch_DBC)
```


### 1.2

```{r message=FALSE}
dict_dutch <- read_csv("0_data/the_Dutch_words.txt",
  col_names = F,
  trim_ws = F,
  na = character()
)

dict_english <- read_csv("0_data/the_English_translation.txt",
  col_names = F,
  trim_ws = F,
  na = character()
)

dict <- set_names(unlist(dict_english), unlist(dict_dutch))

dat_1_2 <- dat %>%
  mutate(
    "DBC Description 1" = str_replace_all(dat$`Omschrijving type 1`, dict)
  ) %>%
  select(Code, "DBC Description 1")

all.equal(dat_1_2, DBC_tibble)
```



# 2. Regarding NZa fees only
## 2.1 Extract the NZa fees

Create a function that imports the DBC codes (column 1) and the NZa fees (column 3) from all NZa sheets in Tarievenoverzicht_HA1.xlsx. When you apply the function on Tarievenoverzicht_HA1.xlsx, the output should be of class tibble and equal to NZa_fees from the data of the Model Answers.

```{r}
extract_NZa_fee <- function(path = "0_data/Tarievenoverzicht_HA1.xlsx") {
  path %>%
    excel_sheets() %>%
    grep("NZA", ., value = T) %>%
    set_names() %>%
    map_dfr(
      ~ read_excel(path = path, sheet = .x)[, c(1, 3)],
      .id = "NZA/year"
    ) %>%
    separate("NZA/year", into = c("NZA", "Year")) %>%
    mutate(
      NZa_fee = coalesce(`basis landelijk`, tarief),
      Code = as.double(code),
      Year = as.double(Year)
    ) %>%
    select(Code, NZa_fee, Year)
}

all.equal(extract_NZa_fee(), NZa_fees)
```



## 2.2 A methodology change in computing the NZa fees.
### 2.2a

```{r message=FALSE}
dat_2_2a <- extract_NZa_fee()

NZa_fee_2014 <- dat_2_2a %>%
  filter(Year == 2014) %>%
  mutate(NZA_2014 = NZa_fee) %>%
  select(NZA_2014, Code)

NZa_comparison <- dat_2_2a %>%
  inner_join(., NZa_fee_2014, key = Code)

NZa_comparison %>%
  filter(Year != 2014) %>%
  na.omit() %>%
  group_by(Year) %>%
  summarise(
    "Min. change in %" = min(100 * (NZa_fee / NZA_2014 - 1)),
    "Average change in %" = mean(100 * (NZa_fee / NZA_2014 - 1)),
    "Median change in %" = median(100 * (NZa_fee / NZA_2014 - 1)),
    "Max. change in %" = max(100 * (NZa_fee / NZA_2014 - 1))
  ) %>%
  round(4) %>%
  kable()
```

### 2.2b 

```{r message=FALSE, warning=FALSE}
data_2_2 <- dat_2_2a %>%
  arrange(Code, Year) %>%
  group_by(Code) %>%
  mutate(
    diff = 100 * (NZa_fee / lag(NZa_fee) - 1),
    Period = paste(as.character(lag(Year)), as.character(Year), sep = "-")
  ) %>%
  ungroup() %>%
  mutate(Year = factor(Year)) %>%
  filter(Year != 2014 & !(Period %in% c("NA-2014", "NA-2015")))

ggplot(data_2_2, aes(x = Period, y = diff)) +
  stat_boxplot(geom ='errorbar') +
  geom_boxplot() +
  labs(y = "% Increase of NZa fees")

```



## 2.3 Statistics and the Methodology for Computing the NZa Fees.
### The Programming Task
```{r message=FALSE}
d <- dat_2_2a %>%
  filter(Year %in% 2016:2018) %>%
  spread(key = Year, value = NZa_fee)

set.seed(123)
B <- 1000
n <- nrow(d)
result <- numeric(B)
perm <- replicate(B, sample(1:n)) %>% matrix(., ncol = B)
beta_hat <- mean(d$`2017`/d$`2016`) - 1
Tj_obs <- var(
  (d$`2017` - (1 + beta_hat) * d$`2016`) / d$`2016` * sqrt(d$`2016` / min(d$`2016`))
  )
for (i in 1:B) {
  idx <- perm[, i]
  h0_perm <- d$`2016` * (d$`2017`[idx] / d$`2016`[idx])
  beta_hat <- mean(h0_perm/d$`2016`) - 1
  result[i] <- var(
    (h0_perm - (1 + beta_hat) * d$`2016`) / d$`2016` * sqrt(d$`2016` / min(d$`2016`))
  )
}

p_value <- mean(result > Tj_obs)

ggplot(as.tibble(result), aes(x = result)) +
  geom_histogram(binwidth = 0.01, fill = "grey", color = "black") +
  geom_vline(xintercept = Tj_obs, col = "red") +
  labs(x = "Tj", title = "2016-2017")
```

The p-value is `r p_value`. Considering an significance level of $\alpha = 0.05/2$ our result is highly significant and we can reject the null hypothesis.

```{r message=FALSE}
set.seed(123)
B <- 1000
n <- nrow(d)
result <- numeric(B)
perm <- replicate(B, sample(1:n)) %>% matrix(., ncol = B)
beta_hat <- mean(d$`2018`/d$`2017`) - 1
Tj_obs <- var(
  (d$`2018` - (1 + beta_hat) * d$`2017`) / d$`2017` * sqrt(d$`2017` / min(d$`2017`))
  )
for (i in 1:B) {
  idx <- perm[, i]
  h0_perm <- d$`2017` * (d$`2018`[idx] / d$`2017`[idx])
  beta_hat <- mean(h0_perm/d$`2017`) - 1
  result[i] <- var(
    (h0_perm - (1 + beta_hat) * d$`2017`) / d$`2017` * sqrt(d$`2017` / min(d$`2017`))
  )
}
p_value_2 <- mean(result > Tj_obs)

ggplot(as.tibble(result), aes(x = result)) +
  geom_histogram(fill = "grey", color = "black") +
  geom_vline(xintercept = Tj_obs, col = "red") +
  labs(x = "Tj", title = "2017-2018")
```

The p-value is `r p_value_2`. Considering an significance level of $\alpha = 0.05/2$ our result is highly insignificant and we can't reject the null hypothesis.

# 3. About the Insurances
## 3.1 Creating the Data Set

```{r}
avrg_contr_fee <- function(path = "0_data/Tarievenoverzicht_HA1.xlsx") {
  insurances <- c("Z&Z", "ZK", "VGZ", "Menzis", "CZ")
  path %>%
    excel_sheets() %>%
    .[grepl(paste(insurances, collapse = "|"), .)] %>%
    set_names() %>%
    map_dfr(
      ~ read_xlsx(path = path, sheet = .x, col_types = "text"),
      .id = "id"
    ) %>%
    separate(id, c("Insurance", "Year"), sep = " ", remove = T) %>%
    transmute(
      Code = as.double(code),
      Fee = as.double(coalesce(`Gecontracteerde tarieven`, `1`)),
      Year = as.double(Year),
      Insurance = factor(Insurance,
        levels = insurances
      )
    )
}

all.equal(avrg_contr_fee(), fees_insurances)
```

## 3.2 Joining the NZa fees, the Insurance fees and the DBC codes with descriptions

```{r message=FALSE}
dat_2_1 <- extract_NZa_fee()
dat_3_1 <- avrg_contr_fee()

dat_NZa <- dat_2_1 %>%
  filter(Code %in% dat_1_2$Code) %>%
  mutate(Year = paste("NZa", Year)) %>%
  spread(key = Year, value = NZa_fee)

dat_3_2 <- dat_3_1 %>%
  filter(Code %in% dat_1_2$Code) %>%
  unite(insurance_year, Insurance, Year, sep = " ") %>%
  spread(key = insurance_year, value = Fee) %>%
  left_join(., dat_NZa, key = Code) %>%
  left_join(., dat_1_2, key = Code) %>%
  select(Code, `DBC Description 1`, everything())

all.equal(dat_3_2, all_fees)
```


### 3.3 Visualizing the Reimbursements for Non-Contracted Healh Care 

```{r message=FALSE, warning=FALSE}
insurance_levels <- c("Z&Z", "ZK", "VGZ", "Menzis", "CZ")
insurance_colors <- c(
  CZ = "orange",
  Menzis = "blue4",
  VGZ = "green4",
  `Z&Z` = "cornflowerblue",
  ZK = "darkred"
)

dat_fig_2 <- dat_3_2 %>%
  gather(key = "insurance_year", value = "fee", -Code, -`DBC Description 1`) %>%
  separate(insurance_year, c("Insurance", "Year"), sep = " ", remove = T) %>%
  filter(Insurance != "NZa") %>%
  mutate(Year = as.double(Year)) %>%
  left_join(., dat_2_1) %>%
  mutate(
    fee_0.75 = 75 * fee / NZa_fee,
    Insurance = factor(Insurance, levels = insurance_levels)
  )

ggplot(dat_fig_2, aes(x = Code, y = fee_0.75)) +
  geom_point(aes(color = Insurance)) +
  facet_grid(cols = vars(Year)) +
  scale_x_continuous(breaks = c(7, 100, 200, 300)) +
  ylim(50, 80) +
  scale_color_manual(values = insurance_colors) +
  labs(y = "% of NZa Fee Reimbursed") +
  theme(legend.title = element_blank())
```

## 3.4 About the Methodology of Average Contracted Fees

```{r}
dat_fig_3 <- dat_fig_2 %>%
  select(-`DBC Description 1`, -NZa_fee, -fee_0.75) %>%
  filter(Insurance != "NZa") %>%
  arrange(Code, Insurance) %>%
  group_by(Insurance, Code) %>%
  mutate(
    diff = 100 * (fee / lag(fee) - 1),
    Period = paste(as.character(lag(Year)), as.character(Year), sep = "-")
  ) %>%
  ungroup() %>%
  mutate(
    Insurance = factor(Insurance, levels = insurance_levels)
  ) %>%
  filter(!is.na(diff))

ggplot(dat_fig_3, aes(x = Insurance, y = diff, color = Insurance)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  scale_color_manual(values = insurance_colors) +
  facet_grid(rows = vars(Period)) +
  labs(y = "Fee Increase in %") +
  theme(
    legend.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

For VGZ the in or decrease of its fees is for every interval up until the last one constant, which means they used the same percentage of change for every code in one particular interval. The interval from 2017-2018 breaks with that rule, GVZ used multiple different percentages of change for its codes.

### 3.4a Average Contracted Fees

```{r}
dat_3_2 %>%
  select(matches("VGZ"), `NZa 2014`) %>%
  na.omit %>%
  cor(.) %>%
  round(4) %>%
  kable()
```

Don't forget to interpret!

### 3.4b 



### 3.4c



## 3.5 Statistics on the % NZa fee reimbursed?



### 3.5a Boostrapped quantile intverals for VGZ and ZK?



### 3.5b Exploiting Symmetry $\theta$



# 4. A Small Monte-Carlo Study regarding symmetry about $\theta$



## 4.1 Type-I error



## 4.2 Power: More about symmetry about $\theta$



## 4.3 Reflecting on Permutation Tests.
### 4.3a



### 4.3b


